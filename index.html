<!DOCTYPE html>
<html>

<head>
    <title>Wesley APK List</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/main.css">

</head>

<body>
    <div id="apkList" class="list-group">
        <div id="title-bar" class="list-group-item active">
            <span class="title-span">APK列表</span>

            <div id="progress" class="progress dsnone">
                <div class="progress-bar progress-bar-info"></div>
            </div>
        </div>
    </div>


    <span class="btn btn-info fileinput-button">
    <i class="glyphicon glyphicon-plus"></i>
    <input id="fileupload" type="file" name="files" accept=".apk" multiple>
</span>

    <div class="modal fade dialog-list-item" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="list-group">
                <a id="download" class="list-group-item">下載<span
                    class="glyphicon glyphicon-download-alt pull-left"></span></a>
                <a id="copyLink" class="list-group-item" data-clipboard-text="">複製下載連結
                <span class="glyphicon glyphicon-file pull-left"></span></a>
                <a id="delete" class="list-group-item">刪除<span
                    class="glyphicon glyphicon-trash pull-left"></span></a>
            </div>
        </div>
    </div>

    <!--<div class="modal fade dialog-pwd" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body text-left">
                    <label for="input_pwd">密碼</label>
                    <input type="password" class="form-control" id="input_pwd" placeholder="Password"
                           data-container="body" data-toggle="popover" data-trigger="manual" data-placement="top"
                           data-content="密碼錯誤。">
                    <br>
                    <button id="pwd_enter" class="btn btn-default">確定</button>
                </div>
            </div>
        </div>
    </div>
</div>-->

    <div class="modal fade dialog-loading" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"
        data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <img src="images/loading.gif" width="100px" height="100px">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>


<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/clipboard.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/vendor/jquery.ui.widget.js"></script>
<script src="js/jquery.iframe-transport.js"></script>
<script src="js/jquery.fileupload.js"></script>

<script>
    //複製到剪貼簿物件
    var clipboard = new Clipboard('#copyLink');
    //解決Bootstrap與複製剪貼簿衝突問題
    $.fn.modal.Constructor.prototype.enforceFocus = function () { };

    clipboard.on('success', function (e) {
        $(".dialog-list-item").modal('hide');
        showSuccess("成功複製連結至剪貼簿!");
        e.clearSelection();
    });

    //顯示讀取中圖示
    $('.dialog-loading').modal('show');

    //登入過就啟用上傳功能
    /*if(sessionStorage.isLogin == 1){
        $("#fileupload").show();
    } else {
        $("#fileupload").hide();
    }
*/
    getFileList();

    /** 取得檔案列表 */
    function getFileList() {
        $.get("get_file_list.php", function (data) {
            //先移除所有列表在加入
            $(".apkItem").remove();
            var jsonFileList = JSON.parse(data);
            SortData(jsonFileList, "filetime", "down");
            var strDOM = "";
            for (var index in jsonFileList) {
                var strURL = location.href;
                var strFile = jsonFileList[index];
                strDOM += '<a class="list-group-item apkItem" data-toggle="modal" data-target=".dialog-list-item">' +
                    '<div><strong>' + strFile.filename + '</strong></div>' +
                    '<span class="list-group-item-text">' + strFile.filetime + '</span>' +
                    '<span class="glyphicon glyphicon-chevron-down pull-right"></span>' +
                    '</a>';
            }
            $("#apkList").append(strDOM);

            //隱藏讀取中圖示
            $('.dialog-loading').modal('hide');
        });
    }

    /** 第一次開啟網頁需登入過一次才能上傳 */
    /*$('.fileinput-button').on('click', function () {
        if(sessionStorage.isLogin == 1){

        } else {
            //type為create
            $("#input_pwd").data("type", "create");
            //顯示密碼輸入框
            $('.dialog-pwd').modal('show');
            $('#input_pwd').focus();
        }
    });*/

    /** 檔案上傳 */
    $('#fileupload').fileupload({
        url: "upload.php",
        done: function (e, data) {
            $('#progress').hide();
            showSuccess(data.result);
            getFileList();
        },
        progressall: function (e, data) {
            $('#progress').show();
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                'width',
                progress + '%'
            );
            $('#progress .progress-bar').text(progress + '%');
        }
    });

    /** 出現項目子選單時 */
    $(".dialog-list-item").on("show.bs.modal", function (e) {
        var strFileName = e.relatedTarget.children[0].children[0].innerHTML;
        $("#download").attr("href", location.href + "apk/" + strFileName);
        $("#copyLink").attr("data-clipboard-text", location.href + "apk/" + strFileName);
        $("#delete").data("filename", strFileName);
    });

    /** 輸入密碼框消失時 */
    /*$(".dialog-pwd").on("hide.bs.modal", function (e) {
        //清空輸入框文字
        $("#input_pwd").val("");
        //隱藏密碼錯誤訊息
        $("#input_pwd").popover('hide');
    });*/

    /** 點擊刪除按鈕 */
    $("#delete").on("click", function () {
        var strFileName = $("#delete").data("filename");
        //開始刪除檔案
        $.post("delete.php", { "filename": strFileName }, function (data) {
            $(".dialog-list-item").modal('hide');
            //            $('.dialog-pwd').modal('hide');
            showSuccess(data);
            getFileList();
        });
        /*//type為delete
        $("#input_pwd").data("type", "delete");
        //顯示密碼輸入框
        $('.dialog-pwd').modal('show');
        $('#input_pwd').focus();*/
    });

    /** 點擊密碼確定按鈕 */
    /*$("#pwd_enter").on("click", function () {
        //取得type及當前輸入密碼
        var type = $("#input_pwd").data("type");
        var pwd = $("#input_pwd").val();
        //確認密碼是否正確
        $.post("db_check_pwd.php", {"type": type, "pwd": pwd}, function (data) {
            var jsonObj = JSON.parse(data);
            //success == 1 為正確
            if (jsonObj.success == 1) {
                sessionStorage.isLogin = 1;
                //刪除檔案
                if (type == "delete") {
                    var strFileName = $("#delete").data("filename");
                    //開始刪除檔案
                    $.post("delete.php", {"filename": strFileName}, function (data) {
                        $(".dialog-list-item").modal('hide');
                        $('.dialog-pwd').modal('hide');
                        showSuccess(data);
                        getFileList();
                    });
                    //新增檔案
                } else if (type == "create") {
                    //隱藏密碼輸入框
                    $('.dialog-pwd').modal('hide');
                    //讓上傳功能可用
                    $("#fileupload").show();
                }
            }
            else {
                //顯示密碼錯誤提示
                $("#input_pwd").popover('show');
            }
        });
    });*/

    /** 顯示訊息 */
    function showSuccess(data) {
        $(".animated").remove();
        var animationEnd = "webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend";
        $("body").append('<div class="alert alert-success animated flipInX" role="alert">' + data + '</div>');
        $(".animated").one(animationEnd,
            function () {
                setTimeout('$(".animated").removeClass("flipInX").addClass("flipOutX")', 1000);
                setTimeout('$(".animated").remove()', 2000);
            });
    }

    /** 排序 */
    function SortData(datas, field, type) {
        SortFun.field = field;
        datas.sort(SortFun);
        if (type == "down") {
            datas.reverse();
        }
    }
    function SortFun(data1, data2) {
        if (data1[SortFun.field] > data2[SortFun.field]) {
            return 1;
        }
        else if (data1[SortFun.field] < data2[SortFun.field]) {
            return -1;
        }
        return 0;
    }
</script>

</html>